---
title: 最佳实践
sidebar_label: 最佳实践
sidebar_position: 3
---

import MultiLang from '/src/docComponents/MultiLang';
import CodeBlock from '@theme/CodeBlock';
import sdkVersions from '/src/docComponents/sdkVersions';

平台推荐集成3.29.0 及以上版本的 SDK，配套使用 TapTap 登录 + 合规认证服务，以达到最佳用户体验。

## 准备工作

### 创建应用获取应用参数
在 [TapTap 开发者中心](https://developer.taptap.cn) 创建游戏应用，获取应用 Client ID、Client Token 等参数，用于初始化 SDK；

![](https://capacity-files.lcfile.com/nnQKxgJJzgErOlIOcxnbIHt8Vc1RmGYe/tap_get_ready.png)

### 开通 TapTap 登录服务
合规认证服务依赖于 TapTap 登录服务，因此，厂商需要在 **TapTap 开发者中心 > 你的游戏 > 游戏服务 > 应用配置** 开启「TapTap 登录」；

![](https://img.tapimg.com/market/images/168f902edd3de84cf0d5eb5fa640e78d.png)

### 配置应用包名和签名信息
Android 签名处填写 MD5 值，详情可参考：[如何获取 MD5 值](/sdk/start/faq/#如何获取-android-应用的-md5-值)；

![](https://img.tapimg.com/market/images/3c725fc6859363f630d90471d0c8929b.png)

### 开通合规认证服务
找到 **TapTap 开发者中心 > 你的游戏 > 游戏服务 > 开发与构建 > 合规认证**，根据游戏实际情况，选择「已有版号」或「暂无版号」方案，然后点击**立即开通**

![](https://img.tapimg.com/market/images/90e6d759ba528aa7e9ef29077387edbb.png)

:::tip
若游戏选择的是「已有版号」方案则还需要完成中宣部实名认证系统的注册以及相应配置，具体的操作请参考 [注册中宣部实名认证系统](/sdk/anti-addiction/features/#已有版号)
:::

### 可玩年龄限制
应用需要对用户年龄有额外限制时，可在 **TapTap 开发者中心 > 你的游戏 > 游戏服务 > 合规认证 > 可玩年龄限制** 中开启此功能，并配置所需的**最低年龄要求**

在后续的代码集成中，也需要处理相关的 `1100` 回调

![](https://img.tapimg.com/market/images/e7fab2ce4099b792bd32390c04e28986.png)

## 代码接入

### 导入 SDK 包体

<MultiLang kind="alone_unity">

<>

在项目的 `Packages/manifest.json` 文件中添加以下依赖：

<CodeBlock className="json">
  {`"dependencies":{
    "com.taptap.tds.login":"https://github.com/TapTap/TapLogin-Unity.git#${sdkVersions.taptap.unity}",
    "com.taptap.tds.common":"https://github.com/TapTap/TapCommon-Unity.git#${sdkVersions.taptap.unity}",
    "com.tapsdk.antiaddiction":"https://github.com/TapTap/TapAntiAddiction-Unity.git#${sdkVersions.taptap.unity}",
    "com.leancloud.storage": "https://github.com/leancloud/csharp-sdk-upm.git#storage-${sdkVersions.leancloud.csharp}",
}`}
</CodeBlock>


在 Unity 顶部菜单中选择 **Window > Package Manager** 可查看已经安装在项目中的包。

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>


### 初始化与设置回调

<MultiLang kind="alone_unity">

<>

先进行 SDK 初始化，然后调用以下的实名认证接口完成 TDS 的实名认证功能。**请在 Unity 生命周期中的 `Start()` 方法或者 `Awake()` 方法中执行 SDK 的初始化。**

```cs
// 引入命名空间
using TapTap.Login;
using TapTap.Common;
using TapTap.AntiAddiction;
using TapTap.AntiAddiction.Model;

// 将以下代码复制到 Start() 或 Awake() 方法中

// 应用参数配置
string clientId = "游戏的 Client ID"; // TapTap 开发者中心对应 Client ID

// 初始化 TapTap 登录（单纯 TapTap 用户认证方式）
TapLogin.Init(clientId);

// 定义防沉迷模块 config
AntiAddictionConfig config = new AntiAddictionConfig()
{
    gameId = clientId,          // TapTap 开发者中心对应 Client ID
    showSwitchAccount = false,  // 是否显示切换账号按钮，根据游戏自身需求设置是否显示「切换账号」按钮
    useAgeRange = false         // 是否使用年龄段信息，false 静默授权，用户体验更好；true 获取玩家实名认证后的年龄段信息
};

// 定义回调，此处需要游戏自行实现
Action<int, string> callback = (code, errorMsg) => {

    UnityEngine.Debug.LogFormat($"code: {code} error Message: {errorMsg}");

    // 根据 code 不同提示玩家不同信息，详见下面的说明
    if (code == 500)
    {
        // 玩家未受到限制，正常进入游戏
    }
    if (code == 1000)
    {
        // 退出账号，当调用 AntiAddictionUIKit.Exit() 接口时触发
        // 玩家在游戏内退出账号时调用该接口，重置防沉迷状态。
    }
    if (code == 1001)
    {
        // 说明玩家在实名认证过程中，点击了「切换账号」按钮会触发该回调，同时实名认证的弹窗会被销毁
        // 需要游戏重新触发实名认证，正确引导玩家完成实名认证
    }
    if (code == 1100)
    {
        // 当前未成年玩家因触发应用设置的适龄限制无法进入游戏
    }
    if (code == 1200)
    {
        // 数据请求失败，游戏需检查当前设置的应用信息是否正确及判断当前网络连接是否正常
    }
    if (code == 9002)
    {
        // 实名认证过程中玩家点击了关闭实名窗，说明玩家并没有完成实名认证，是不可以进入游戏的
        // 需要重新触发实名认证，正确引导玩家完成实名认证
    }
};

// 再初始化合规认证
AntiAddictionUIKit.Init(config);
AntiAddictionUIKit.SetAntiAddictionCallback(callback);
```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>


### TapTap 登录 & 开始实名认证

游戏完成 SDK 的初始化后，接下来需要完成 TapTap 登录，TapTap 登录成功后，再进行实名认证。

:::tip
TapTap 登录按钮素材需要使用官方提供的[登录按钮素材](https://assets.tapimg.com/img/TapTap_Login_Source.zip)；
:::

<MultiLang kind="alone_unity">

<>

```cs
try
{
    var accessToken = await TapLogin.Login();
    Debug.Log($"TapTap 登录成功 accessToken: {accessToken.ToJson()}");

    // TapTap 登录成功后可以通过 Profile  获得当前用户的一些基本信息，例如名称、头像。
    var profile = await TapLogin.FetchProfile();
    Debug.Log($"TapTap 登录成功 profile: {profile.ToJson()}");

    // 实名认证，TapTap 登录成功后，游戏需要调用 `StartupWithTapTap` 接口进行实名认证
    string userIdentifier = profile.unionid;
    AntiAddictionUIKit.StartupWithTapTap(userIdentifier);  // 调用 StartupWithTapTap 接口才会触发实名认证回调，玩家的最终实名认证结果通过回调给出
}
catch (Exception e)
{
    if (e is TapException tapError)  // using TapTap.Common
    {
        Debug.Log($"encounter exception:{tapError.code} message:{tapError.message}");
        if (tapError.code == (int)TapErrorCode.ERROR_CODE_BIND_CANCEL) // 取消登录
        {
            Debug.Log("登录取消");
        }
    }
}
```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>

### 限制未成年人消费额度

:::tip
每次充值之前，游戏侧请 **务必** 调用 `CheckPayLimit` 接口进行判断，检验当前玩家的付费行为是否被限制。消费金额的单位为分。
:::

<MultiLang kind="alone_unity">

<>

```cs
long amount = 100;    // 100 表示 100 分，即 1 元
AntiAddictionUIKit.CheckPayLimit(amount,
    (result) => {
        // status 为 1 时可以支付
        int status = result.status;
        if (status == 1) {
            // 可以进行支付
        } else {
          // 说明玩家当前这笔消费不可以再继续了，如果继续就超过了限制，游戏侧需要拦截这笔消费
        }
    },
    (exception) => {
        // 处理异常
    }
);
```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>


:::tip
消费成功后，游戏侧请 **务必** 调用 `SubmitPayResult` 接口上报玩家消费金额。上报消费金额时，传入的消费金额的单位同样为分。
:::

<MultiLang kind="alone_unity">

<>

```cs
long amount = 100;
AntiAddictionUIKit.SubmitPayResult(amount,
    () => {
        // 成功
    }, (exception) => {
        // 处理异常
    }
);
```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>
