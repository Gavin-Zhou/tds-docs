---
title: 最佳实践
sidebar_label: 最佳实践
sidebar_position: 3
---

import MultiLang from '/src/docComponents/MultiLang';
import CodeBlock from '@theme/CodeBlock';
import sdkVersions from '/src/docComponents/sdkVersions';

平台推荐集成3.29.0 及以上版本的 SDK，配套使用 TapTap 登录 + 合规认证服务，以达到最佳用户体验。

## 准备工作

### 创建应用获取应用参数
在 [TapTap 开发者中心](https://developer.taptap.cn) 创建游戏应用，获取应用 Client ID、Client Token 等参数，用于初始化 SDK；

![](https://capacity-files.lcfile.com/nnQKxgJJzgErOlIOcxnbIHt8Vc1RmGYe/tap_get_ready.png)

### 开通 TapTap 登录服务
合规认证服务依赖于 TapTap 登录服务，因此，厂商需要在 **TapTap 开发者中心 > 你的游戏 > 游戏服务 > 应用配置** 开启「TapTap 登录」；

![](https://img.tapimg.com/market/images/168f902edd3de84cf0d5eb5fa640e78d.png)

### 配置应用包名和签名信息
Android 签名处填写 MD5 值，详情可参考：[如何获取 MD5 值](/sdk/start/faq/#如何获取-android-应用的-md5-值)；

![](https://img.tapimg.com/market/images/3c725fc6859363f630d90471d0c8929b.png)

### 开通合规认证服务
找到 **TapTap 开发者中心 > 你的游戏 > 游戏服务 > 开发与构建 > 合规认证**，根据游戏实际情况，选择「已有版号」或「暂无版号」方案，然后点击**立即开通**

![](https://img.tapimg.com/market/images/90e6d759ba528aa7e9ef29077387edbb.png)

:::tip
若游戏选择的是「已有版号」方案则还需要完成中宣部实名认证系统的注册以及相应配置，具体的操作请参考 [注册中宣部实名认证系统](/sdk/anti-addiction/features/#已有版号)
:::

### 可玩年龄限制
应用需要对用户年龄有额外限制时，可在 **TapTap 开发者中心 > 你的游戏 > 游戏服务 > 合规认证 > 可玩年龄限制** 中开启此功能，并配置所需的**最低年龄要求**

在后续的代码集成中，也需要处理相关的 `1100` 回调

![](https://img.tapimg.com/market/images/e7fab2ce4099b792bd32390c04e28986.png)

## 代码接入

### 导入 SDK 包体

<MultiLang kind="alone_unity">

<>

在项目的 `Packages/manifest.json` 文件中添加以下依赖：

<CodeBlock className="json">
  {`"dependencies":{
    "com.taptap.tds.login":"https://github.com/TapTap/TapLogin-Unity.git#${sdkVersions.taptap.unity}",
    "com.taptap.tds.common":"https://github.com/TapTap/TapCommon-Unity.git#${sdkVersions.taptap.unity}",
    "com.tapsdk.antiaddiction":"https://github.com/TapTap/TapAntiAddiction-Unity.git#${sdkVersions.taptap.unity}",
    "com.leancloud.storage": "https://github.com/leancloud/csharp-sdk-upm.git#storage-${sdkVersions.leancloud.csharp}",
}`}
</CodeBlock>


在 Unity 顶部菜单中选择 **Window > Package Manager** 可查看已经安装在项目中的包。

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>


### 初始化与设置回调

<MultiLang kind="alone_unity">

<>

**在游戏主场景生命周期中的 `Start()` 或 `Awake()` 方法中执行 SDK 的初始化，** 并调用开始认证接口进入合规认证处理流程，示例如下：

```cs
using TapTap.Login;
using TapTap.Common;
using TapTap.AntiAddiction;
using TapTap.AntiAddiction.Model;
using UnityEngine;
using System;


public class GameMainScene: MonoBehaviour {

	 // 游戏在 TapTap 开发者中心对应的 Client ID
	private readonly string clientId = "游戏的 Client ID";
	
	// 合规认证回调声明
	private Action<int, string> AntiAddictionCallback => (code, extra)=> {
      // 根据回调返回的参数 code 添加不同情况的处理
      switch (code){
        //玩家未受限制，可正常进入
        case 500: 
                  //TODO: 进入游戏
                  break;
        // 退出账号，当调用 AntiAddictionUIKit.Exit() 接口时触发          
        case 1000: 
        // 玩家在实名认证过程中，点击了「切换账号」按钮       
        case 1001:
                  //TODO: 切换到登录页面
                  break;
        // 当前玩家触发游戏设置的适龄限制         
        case 1100:
                  //TODO: 弹出游戏绘制的适龄限制提示，并引导玩家退出游戏或切换账号
                  break;   
        // 数据请求失败，游戏需检查当前设置的应用信息是否正确或引导玩家查看当前网络连接是否正常               
        case 1200:
                  //TODO: 引导玩家查看当前网络连接是否正常，并重新调用开始认证接口进入合规认证处理流程 
                  break;
        // 实名认证过程中玩家点击了关闭实名窗口        
        case 9002:
                  //TODO: 重新调用开始认证接口进入合规认证处理流程 或 切换到登录页面
                  break;
        default:
                  break;                                        
      }

    };
    
    /// <summary>
    /// 游戏场景的 Start 回调方法
    /// </summary>
  public void Start() {
  
    // 初始化 TapTap 登录（单纯 TapTap 用户认证方式）
	  TapLogin.Init(clientId);
	
    // 定义合规认证模块 config
    AntiAddictionConfig config = new AntiAddictionConfig()
    {
        gameId = clientId,          // TapTap 开发者中心对应 Client ID
        showSwitchAccount = false,  // 是否显示切换账号按钮
        useAgeRange = false         // 是否使用年龄段信息
     };

    // 初始化合规认证及设置回调
    AntiAddictionUIKit.Init(config);
    AntiAddictionUIKit.SetAntiAddictionCallback(AntiAddictionCallback);
  }
}



```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>


### TapTap 登录 & 开始实名认证

游戏完成 SDK 的初始化后，接下来需要完成 TapTap 登录，TapTap 登录成功后，再进行实名认证。

:::tip
TapTap 登录按钮素材需要使用官方提供的[登录按钮素材](https://assets.tapimg.com/img/TapTap_Login_Source.zip)；
:::

<MultiLang kind="alone_unity">

<>

```cs
try {
		 // 检查之前是否已登录
        AccessToken accessToken = await TapLogin.GetAccessToken();
        if (accessToken == null) {
        	  //未登录时，发起登录
            accessToken = await TapLogin.Login();
        } 
        // 登录成功后可以通过 Profile  获得当前用户的一些基本信息
        var profile = await TapLogin.FetchProfile();
        string userIdentifier = profile.unionid;
        // 使用当前 Tap 用户的 unionid 作为用户标识进行合规认证检查
        AntiAddictionUIKit.StartupWithTapTap(userIdentifier);         
    } 
   	 catch (Exception e) {
	 	 // 登录取消或失败
	 	 //TODO: 提示用户重新登录
	 }
```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>

### 限制未成年人消费额度

:::tip
每次充值之前，游戏侧请 **务必** 调用 `CheckPayLimit` 接口进行判断，检验当前玩家的付费行为是否被限制。消费金额的单位为分。
:::

<MultiLang kind="alone_unity">

<>

```cs
long amount = 100;    // 100 表示 100 分，即 1 元
AntiAddictionUIKit.CheckPayLimit(amount,
    (result) => {
        // status 为 1 时可以支付
        int status = result.status;
        if (status == 1) {
            // 可以进行支付
        } else {
          // 本次消费触发合规限制，游戏侧需停止后续付费流程
          //TODO: 游戏提示玩家无法充值
        }
    },
    (exception) => {
        // 处理异常
    }
);
```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>


:::tip
消费成功后，游戏侧请 **务必** 调用 `SubmitPayResult` 接口上报玩家消费金额。上报消费金额时，传入的消费金额的单位同样为分。
:::

<MultiLang kind="alone_unity">

<>

```cs
long amount = 100;
AntiAddictionUIKit.SubmitPayResult(amount,
    () => {
        // 成功
    }, (exception) => {
        // 处理异常
    }
);
```

</>
<>

```java

```

</>
<>

```objc

```  
</>

<>

```cpp

```

</>

</MultiLang>
